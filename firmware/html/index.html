<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web based Integrated Logic Analyzer (ILA)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Web based Integrated Logic Analyzer (ILA)</h1>

  <p>Click the buttons below to control the ILA</p>

  <div>
    <button onclick="onClickArm()">Arm</button>
    <button onclick="onClickUpdate()">Update</button>
  </div>

  <div>
    <div id="runningText">Not Running</div>
    <div id="triggeredText">Not Triggered</div>
  </div>

  <iframe src="https://app.surfer-project.org/" id="surfer_iframe"
    frameborder="0" style="position:absolute;top:20%;left:0;width:100%;height:80%;">
    Please wait while loading Surfer WASM. Initial download may take up to 1-2 minutes as ESP32 Wifi is slow. Subsequent loads will be cached by the browser.
  </iframe>

  <script>

    const iframe = document.getElementById('surfer_iframe');

    function onPollStatus() {
      fetch('/ila_status').then((response) => {
      response.json().then((data) => {
        // console.log(data);
        const runningElement = document.getElementById("runningText");
        const triggeredElement = document.getElementById("triggeredText");

        runningElement.style.color = data.running ? "red" : "black";
        runningElement.textContent = data.running ? "Running" : "Not Running";
        triggeredElement.style.color = data.triggered ? "red" : "black";
        triggeredElement.textContent = data.triggered ? "Triggered" : "Not Triggered";
      });
    });
    }

    function onClickArm() {
      fetch('/ila_arm')
        .catch(error => console.error('Error:', error));
    }

    function onClickUpdate() {
      //const vcd = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/ila.vcd"
      const vcd = window.location.protocol + "//" + window.location.hostname + "/ila.vcd";
      iframe.contentWindow.postMessage({command: "LoadUrl", url: vcd}, "*");
      const command = JSON.stringify('ToggleMenu');
      iframe.contentWindow.postMessage({command: "InjectMessage", message: command}, "*");
    }

    setInterval(onPollStatus, 1000);

  </script>
</body>
</html>
